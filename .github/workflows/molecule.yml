---
# Molecule testing workflow for community.openwrt collection
# This workflow runs molecule tests against various combinations of
# Ansible and Python versions to ensure compatibility

name: Molecule
on:
  # Run tests against all pushes (direct commits, also merged PRs), Pull Requests
  push:
    branches:
      - main
      - stable-*
  pull_request:
  # Run tests once per day (at 06:00 UTC)
  # This ensures that even if there haven't been commits that we are still
  # testing against latest version of ansible-core
  schedule:
    - cron: "0 6 * * *"

concurrency:
  group: >-
    ${{ github.workflow }}-${{
      github.event.pull_request.number || github.sha
    }}
  cancel-in-progress: true

env:
  COLORTERM: "yes"
  TERM: "xterm-256color"

jobs:
  molecule:
    name: Molecule (â’¶${{ matrix.ansible }}+py${{ matrix.python }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ansible:
          - ""
        python:
          - ""
        target:
          - ""
        exclude:
          - ansible: ""
        include:
          # ansible-core 2.17
          - ansible: stable-2.17
            python: "3.10"
          - ansible: stable-2.17
            python: "3.11"
          - ansible: stable-2.17
            python: "3.12"
          # # ansible-core 2.18
          - ansible: stable-2.18
            python: "3.11"
          - ansible: stable-2.18
            python: "3.12"
          - ansible: stable-2.18
            python: "3.13"
          # # ansible-core 2.19
          - ansible: stable-2.19
            python: "3.11"
          - ansible: stable-2.19
            python: "3.12"
          - ansible: stable-2.19
            python: "3.13"
          # # ansible-core 2.20
          - ansible: stable-2.20
            python: "3.12"
          - ansible: stable-2.20
            python: "3.13"
          - ansible: stable-2.20
            python: "3.14"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: ansible_collections/community/openwrt

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: "pip"

      - name: Install ansible-core (${{ matrix.ansible }})
        run: pip install https://github.com/ansible/ansible/archive/${{ matrix.ansible }}.tar.gz --disable-pip-version-check

      - name: Install test dependencies
        working-directory: ansible_collections/community/openwrt
        run: pip install -r requirements.txt --disable-pip-version-check

      - name: Install collection dependencies
        working-directory: ansible_collections/community/openwrt
        run: |
          ansible-galaxy collection install ansible.netcommon
          ansible-galaxy collection install ansible.utils

      - name: Run molecule tests (default scenario)
        working-directory: ansible_collections/community/openwrt
        run: molecule test --scenario-name default
        env:
          PY_COLORS: "1"
          ANSIBLE_FORCE_COLOR: "1"

  check:
    # This job does nothing and is only used for the branch protection
    # or multi-stage CI jobs, like making sure that all tests pass before
    # a publishing job is started.
    if: always()

    needs:
      - molecule

    runs-on: ubuntu-latest

    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
